<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Online Chat</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

<article id="conversation">
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-form" id="chat-form">
        <label for="new-message-text">Jot down something</label>
        <input type="text" id="new-message-text" required minlength="1" maxlength="32" placeholder="Type your message..."/>
        <button id="new-message-submit">Send</button>
    </div>
</article>

<script>
    const joinChat = fetch("/join")
        .then(r => r.json())
        .then(data => {
            return data;
        });

    window.onload = async () => {
        const me = await joinChat;

        const source = new EventSource('/register?clientID=' + me.id);

        source.onmessage = (event) => {
            const response = JSON.parse(event.data);

            const chat = document.getElementById('chat-messages');
            const message = document.createElement("div");
            message.className = "message";
            message.innerHTML = `
              <span class="username">${response.authorName}</span>
              <span class="text ${response.authorID === me.id ? "me" : "other"}">${response.message}</span>
            `;
            chat.appendChild(message);
        };

        document.getElementById("new-message-submit").onclick = function () {
            const message = document.getElementById('new-message-text').value;
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/message');
            xhr.setRequestHeader('Content-Type', 'text/plain');
            xhr.send(JSON.stringify({message: message, clientID: me.id}));
        }
    };
</script>

</body>
</html>